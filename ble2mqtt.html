<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>BLE2MQTT</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        h1 {
            background-color:cornflowerblue;
            color: azure;
        }
        h2 {
            color:coral;
        }
        input {
            width: 100%;
        }
        table {
            border-collapse: collapse;
            width: 100%;
        }
        table, table thead tr, table tbody tr {
            border: solid 1px cadetblue;
        }
        table thead td, table tbody td {
            border: dashed 1px cadetblue;
        }
        table thead td {
            background-color:cadetblue;
            color: azure;
        }
    </style>
</head>
<body>

<h1>BLE2MQTT</h1>

<h2>Connection</h2>

<label for=txtUrl"">MQTT Broker URL:
    <div>
        <input id="txtUrl" onchange="setUrl(this.value)"/>
    </div>
</label>
<button id="btnConnect"    type="button" onclick="connect()"    />Connect</button>    
<button id="btnDisconnect" type="button" onclick="disconnect()" />Disconect</button>    

<h2>Devices</h2>
<div id="divDevices">
    <table id="tblDevices">
        <thead>
            <tr>
                <td key="address"     >Address</td>
                <td key="update"      >Update</td>
                <td key="rssi"        >RSSI</td>
                <td key="manufacture" >Manufatcure</td>
                <td key="model"       >Model</td>
                <td key="battery"     >Battery[%]</td>
                <td key="temperature" >Temperature[â„ƒ]</td>
                <td key="humidity"    >Humidity[%]</td>
                <td key="status"      >State</td>
                <td key="power"       >Power[W]</td>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>

const connectOptions = {
  clean: true,
  connectTimeout: 4000,
  clientId: 'websocket_client',
  username: '',
  password: '',
}

var url = "ws://mqtt.local:8883"
var rootTopic = "ble2mqtt"
var keywords = "device_name,rssi,device_type,battery,temperature,humidity,status,power"
var client;

document.querySelector('#txtUrl').value = url
document.querySelector('#btnConnect').disabled = null
document.querySelector('#btnDisconnect').disabled = "disabled"
console.log("Page loaded.")

async function setUrl(value) {
    url = value;
    console.log("Set URL: " + value);
}

async function connect() {
    console.log("Conncting...")
    client  = mqtt.connect(url, connectOptions)

    client.on('connect', function() {
        console.log('Connected.')
        document.querySelector('#btnConnect').disabled = "disabled"
        document.querySelector('#btnDisconnect').disabled = null
        subscribe(rootTopic + '/#')
    })
    client.on('close', function() {
        console.log('Closed.')
        document.querySelector('#btnConnect').disabled = null
        document.querySelector('#btnDisconnect').disabled = "disabled"
    })
    client.on('message', function(topic, message) {
        console.log(topic + ": " + message.toString())
        updateTable(topic, message)
    })

    client.on('reconnect', function () {
        console.log('Reconnecting...')
    })
    client.on('disconnect', function (packet) {
        console.log(packet)
    })
    client.on('offline', function () {
        console.log('offline')
    })
    client.on('error', function (error) {
        console.log(error)
    })
}

async function disconnect() {
    console.log("Disconnecting...")
    client.end()
}

async function subscribe(topic) {
    console.log("Subscribing...")
    let options = { qos: 0 }
    client.subscribe(topic, options, onsubscribe)
}

function onsubscribe(error, granted) {
    if (error) {
        console.log("Subscribe Error:" + error)
        return
    }
    console.log(`${granted[0].topic} was subscribed`)
}

function onunsubscribe(error) {
    if (error) {
        console.log("Unsubscribe Error:" + error)
        return
    }
    console.log("Unsubscribed.")
}

function updateTable(topic, message) {
    json = JSON.parse(message)
    address = json['address']

    const tbl = document.querySelector('#tblDevices')
    var tr = getOrCreateRow(tbl, 0, address);
    for (c=0; c<tbl.tHead.rows[0].cells.length; c++) {
        th = tbl.tHead.rows[0].cells[c]
        key = th.getAttribute('key')
        tr.cells[c].textContent = json[key]
    }
}

function getOrCreateRow(table, colIndex, value) {
    for (row of table.tBodies[0].rows) {
        if (row.cells[colIndex].textContent === value) {
            return row
        }
    }
    return createRow(table)
}

function createRow(table) {
    row = table.tBodies[0].insertRow(-1)
    for (i=0; i<table.tHead.rows[0].cells.length; i++) {
        row.insertCell(-1)
    }
    return row
}

</script>

</body>
</html>